<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AbogadApp | Documentos</title>

  <!-- Firebase SDKs -->
  <script src="/env-config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --primary: #1a4f8a;
      --secondary: #45b69c;
      --accent: #2c73d2;
      --background: #f0f9ff;
      --error: #dc3545;
      --success: #28a745;
      --dark: #333;
      --light: #f8f9fa;
      --border: #dee2e6;
      --message-shadow: 0 2px 5px rgba(0,0,0,0.1);
      --hover-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    body {
      background: linear-gradient(120deg, var(--background) 0%, #ffffff 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Header Styles */
    .app-header {
      background: white;
      padding: 15px 30px;
      border-radius: 15px;
      box-shadow: var(--message-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
    }

    .logo {
      width: 50px;
      height: 50px;
      object-fit: contain;
      transition: transform 0.2s ease;
    }

    .brand-name {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary);
      letter-spacing: -0.5px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-name {
      color: var(--dark);
      font-weight: 500;
    }

    .logout-btn {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: var(--primary);
    }
    /* Document Container Styles */
    .document-container {
      background: white;
      border-radius: 15px;
      box-shadow: var(--message-shadow);
      border: 1px solid rgba(0,0,0,0.05);
      margin-top: 20px;
      padding: 20px 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .document-container h2 {
      font-size: 18px;
      color: var(--primary);
      margin-bottom: 5px;
      font-weight: 600;
    }

    .file-upload-label {
      background: var(--light);
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-upload-label:hover {
      background: #fafafa;
      border-color: var(--accent);
    }

    .file-upload-label input {
      display: none;
    }

    .file-list {
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
    }

    .file-item {
      padding: 8px;
      margin: 5px 0;
      background: #f8f9fa;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-item small {
      color: #666;
    }

    .doc-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .doc-actions button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .doc-actions button:hover:not(:disabled) {
      background: var(--primary);
      transform: translateY(-1px);
    }

    .doc-actions button:disabled {
      background: var(--border);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .analysis-result {
      background: var(--light);
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      box-shadow: var(--message-shadow);
      display: none;
    }

    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      animation: statusAppear 0.3s forwards;
      z-index: 1000;
    }

    .connection-status.success {
      background: var(--success);
    }

    .connection-status.error {
      background: var(--error);
    }

    @keyframes statusAppear {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .app-header {
        padding: 10px 15px;
        flex-direction: column;
        gap: 15px;
      }

      .brand-name {
        font-size: 20px;
      }

      .document-container {
        padding: 15px;
      }

      .doc-actions {
        flex-direction: column;
      }

      .doc-actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
    <div class="main-container">
      <!-- ENCABEZADO -->
      <header class="app-header">
        <div class="brand" onclick="window.location.href='/menu'">
          <img src="/assets/logo.png" alt="AbogadApp" class="logo">
          <span class="brand-name">AbogadApp</span>
        </div>
        <div class="user-info">
          <span id="userName" class="user-name">Cargando...</span>
          <button id="logoutButton" class="logout-btn">Cerrar sesión</button>
        </div>
      </header>
  
      <!-- DOCS: Múltiples Archivos -->
      <div class="document-container">
        <h2>Análisis de Documentos</h2>
        <p style="color: var(--dark);">
          ¡Hola! Sube uno o varios archivos (contratos, resoluciones, etc.) 
          y describe tu duda principal. AbogadApp te ayudará a interpretarlos.
        </p>
        
        <label class="file-upload-label">
          <div id="fileLabelText">Haz clic o arrastra archivos aquí</div>
          <input type="file" id="fileInput" accept=".txt,.pdf,.png,.jpg,.jpeg,.doc,.docx" multiple />
        </label>
  
        <div id="fileList" class="file-list"></div>
  
        <textarea
          id="queryInput"
          rows="2"
          placeholder="¿Cuál es tu duda principal sobre estos documentos?"
          style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;"
        ></textarea>
  
        <div class="doc-actions">
          <button id="analyzeBtn" disabled>Analizar Documentos</button>
          <button id="clearBtn" class="secondary" style="display: none;">Limpiar</button>
          <div id="selectedFiles" style="font-size: 0.9rem; color: var(--dark);"></div>
        </div>
  
        <div id="analysisResult" class="analysis-result"></div>
      </div>
    </div>
  
    <!-- BOTÓN WHATSAPP -->
    <div class="whatsapp-button" onclick="redirectToWhatsApp()">
      <img src="/assets/whatsapp-icon.png" alt="WhatsApp" class="whatsapp-icon">
    </div>
  
    <script>
      // Configuración de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyD242Qba3E-UgeA1UPXp9PgmjJK_Xg6VKY",
        authDomain: "deudazero-b8e33.firebaseapp.com",
        projectId: "deudazero-b8e33",
        storageBucket: "deudazero-b8e33.firebasestorage.app",
        messagingSenderId: "763390302400",
        appId: "1:763390302400:web:6d9f294001f9af5731b525"
      };
  
      // Inicializar Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
  
      // Verificación de autenticación corregida
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = '/'; // Redirigimos si no hay usuario
          return;
        }
        document.getElementById('userName').textContent = user.displayName || user.email || 'Usuario';
      });
  
      // Manejo de archivos múltiples
      const fileInput = document.getElementById('fileInput');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const clearBtn = document.getElementById('clearBtn');
      const selectedFiles = document.getElementById('selectedFiles');
      const fileList = document.getElementById('fileList');
      const analysisResult = document.getElementById('analysisResult');
      // Manejo de archivos
    fileInput.addEventListener('change', function(e) {
      const files = e.target.files;
      if (files.length > 0) {
        analyzeBtn.disabled = false;
        clearBtn.style.display = 'inline-block';
        selectedFiles.innerHTML = `Archivos seleccionados: ${files.length}`;
        
        // Mostrar lista de archivos
        fileList.innerHTML = '';
        Array.from(files).forEach(file => {
          const fileSize = formatFileSize(file.size);
          const fileDiv = document.createElement('div');
          fileDiv.className = 'file-item';
          fileDiv.innerHTML = `
            <span>${file.name}</span>
            <small>${fileSize}</small>
          `;
          fileList.appendChild(fileDiv);
        });
      } else {
        resetFileInput();
      }
    });

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function resetFileInput() {
      fileInput.value = '';
      analyzeBtn.disabled = true;
      clearBtn.style.display = 'none';
      selectedFiles.innerHTML = '';
      fileList.innerHTML = '';
      analysisResult.style.display = 'none';
    }

    clearBtn.addEventListener('click', resetFileInput);

    // Analizar documentos
    analyzeBtn.addEventListener('click', async function() {
      if (!fileInput.files || fileInput.files.length === 0) return;

      try {
        const user = auth.currentUser;
        if (!user) {
          alert("Por favor inicia sesión para analizar documentos.");
          return;
        }

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Analizando...';

        const token = await user.getIdToken();
        const formData = new FormData();
        
        // Agregar todos los archivos
        Array.from(fileInput.files).forEach((file, index) => {
          formData.append('document', file);
        });
        
        const query = document.getElementById('queryInput').value.trim();
        formData.append('query', query);

        const response = await fetch('/api/analyzeDocument', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          analysisResult.style.display = 'block';
          analysisResult.textContent = data.response;
          analysisResult.scrollIntoView({ behavior: 'smooth' });
        } else {
          throw new Error(data.error || 'Error al analizar documentos');
        }

      } catch (error) {
        console.error('Error:', error);
        showConnectionStatus(error.message || 'Error al procesar los documentos', 'error');
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'Analizar Documentos';
      }
    });

    // Cerrar sesión
    document.getElementById('logoutButton').addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = '/';
      } catch (error) {
        console.error("Error al cerrar sesión:", error);
        showConnectionStatus('Error al cerrar sesión', 'error');
      }
    });

    // Utilidades
    function showConnectionStatus(message, type) {
      const existingStatus = document.querySelector('.connection-status');
      if (existingStatus) existingStatus.remove();

      const statusDiv = document.createElement('div');
      statusDiv.className = `connection-status ${type}`;
      statusDiv.textContent = message;
      document.body.appendChild(statusDiv);

      setTimeout(() => {
        statusDiv.style.opacity = '0';
        setTimeout(() => statusDiv.remove(), 300);
      }, 3000);
    }

    function redirectToWhatsApp() {
      const phoneNumber = '+56999999999';
      const text = encodeURIComponent('Hola, necesito ayuda con varios documentos. ¿Podrías asesorarme?');
      window.open(`https://wa.me/${phoneNumber}?text=${text}`, '_blank');
    }

    // Prevenir cierre accidental
    window.addEventListener('beforeunload', (e) => {
      if (fileInput.files.length > 0 && !analysisResult.textContent) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>